#!/bin/bash
PATH=/usr/local/projects/solrmarc-2.1/dist/bin:$PATH
export PATH
num=0
JAVA_HOME=/usr/java/latest/bin/java
export JAVA_HOME

DATADIR=/usr/local/projects/marc
INPUTDIR=$DATADIR/incoming
PROCESSEDDIR=$DATADIR/processed
RESULTSDIR=$DATADIR/results
verbose=

if [ "$1" == "-v" ]  ; then 
    verbose=1
fi

if [ "$verbose" == "1" ] ; then
    echo copying files from incoming directory
fi

# first move auth files to another directory
for file in `find $INPUTDIR -name '*.auth*' -print`
do
    mv $file $DATADIR/not_processed
done

#make sure directories exist
for dir in prod dev multicore merge debug multicore_2 merge_patch
do
    mkdir $DATADIR/incoming_$dir 2> /dev/null
    mkdir $DATADIR/processed_$dir 2> /dev/null
    mkdir $DATADIR/results_$dir 2> /dev/null
done

for file in `find $INPUTDIR -regex '.*[.]\(del\|mrc\)' -links 1 -print | sort`
do
     fname=`basename $file`
     for dir in prod dev multicore merge debug multicore_2 merge_patch
     do
        ln $file $DATADIR/incoming_$dir/$fname
     done
done


if [ "$verbose" == "1" ] ; then
    echo updating solrpowr:8080/solr index
fi
update.index.job prod blacklight_config.properties

if [ "$verbose" == "1" ] ; then
    echo updating solrpowr:8080/solr index
fi
update.index.job dev blacklight_dev_config.properties

if [ "$verbose" == "1" ] ; then
    echo processing location.txt file to update full_dump_patched
fi

update.patched.merge.job $verbose
patch_dir=/usr/local/projects/marc/patched_debug
patch_out=$patch_dir/location_patch_`date +%Y%m%d`.mrc 

if [ -f "$patch_out" ] ; then
    cp $patch_out $DATADIR/incoming_debug
    cp $patch_out $DATADIR/incoming_multicore_2
fi

if [ "$verbose" == "1" ] ; then
    echo updating multicore index at solrpowr:18983/solr/blacklight_index
fi
update.index.job multicore blacklight_multicore_config.properties

if [ "$verbose" == "1" ] ; then
    echo updating multicore dev index at solrpowr:18983/solr/blacklight_dev_index
fi
update.index.job multicore_2 blacklight_multicore_dev_config.properties

if [ "$verbose" == "1" ] ; then
    echo copying blacklight_indexes to datastamped indexes to use for searching
fi
update.multicore.job


if [ "$verbose" == "1" ] ; then
    echo updating full_dump_updated files with new incoming records.
fi
update.merge.job


if [ "$verbose" == "1" ] ; then
    echo updating development index at solrpowr.lib:8983/solr
fi
update.index.job debug blacklight_test_config.properties


if [ "$verbose" == "1" ] ; then
    echo cleaning up incoming directories
fi
for file in `find $INPUTDIR -regex '.*[.]\(del\|mrc\)' -print | sort`
do
#     echo $file
     fname=`basename $file`
     found=1
     for dir in prod dev multicore sorted debug multicore_2 merge_patch
     do     
         if [ ! -f $DATADIR/processed_$dir/$fname ] 
         then
#             echo "not found in dir $dir"
             found=0
         fi
     done
     if [ $found == "1" ]
     then
#         echo " moving $file to $DATADIR/processed"
         cp $file $DATADIR/processed
     fi
done

for file in `find $INPUTDIR -regex '.*[.]\(del\|mrc\)' -links 1 -print | sort`
do
    rm $file
done
